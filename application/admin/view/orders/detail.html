<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>订单详情</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,user-scalable=yes, minimum-scale=0.4, initial-scale=0.8,target-densitydpi=low-dpi" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="stylesheet" href="{:statics('css')}font.css">
    <link rel="stylesheet" href="{:statics('css')}xadmin.css">
    <link rel="stylesheet" href="{:statics('css')}jindu.css">
    <script src="{:statics('js')}jquery.min.js"></script>
    <script type="text/javascript" src="{:statics('public')}lib/layui/layui.js" charset="utf-8"></script>
    <script type="text/javascript" src="{:statics('js')}xadmin.js"></script>
    <!-- 让IE8/9支持媒体查询，从而兼容栅格 -->
    <!--[if lt IE 9]>
      <script src="https://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
      <script src="https://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
<body class="form-wrap" >
  <div class="x-nav">
    <span class="layui-breadcrumb">
      <a href="javascript:void(0);">首页</a>
      <a href="javascript:void(0);">订单管理</a>
      <a href="javascript:void(0);">订单列表</a>
      <a><cite>订单详情</cite></a>
    </span>
    <a class="layui-btn layui-btn-primary layui-btn-small" style="line-height:38px;margin-top:3px;float:right" href="javascript:location.replace(location.href);" title="刷新">
      <i class="layui-icon" style="line-height:38px;font-size:12px">ဂ刷新</i>
    </a>
    <a class="layui-btn layui-btn-primary layui-btn-small" style="line-height:38px;margin-top:3px;float:right" href="javascript:history.go(-1)" title="返回">
      <i class="fa fa-reply"></i>返回
    </a>
  </div>
  <div class="layui-fluid">
    <div class="layui-card">
      <div class="layui-card-body" style="padding: 15px;">
        {if in_array($one.status,[0,1,2,3,4])}
        <div class="jindu">
          <div class="items {if $one.createtime>'0'}active{/if}"">
            <div class="itemsa">1</div>
            <div class="xianr"></div>
            <p class="title">买家下单</p>
            {if $one.createtime>'0'}
              <p class="times">{$one.createtime|date="Y.m.d"}</p>
              <p class="times">{$one.createtime|date="H:i:s"}</p>
            {/if}
          </div>
          <div class="items {if $one.pay_time>'0'}active{/if}">
            <div class="itemsa">1</div>
            <div class="xianl"></div>
            <div class="xianr"></div>
            <p class="title">买家付款</p>
            {if $one.pay_time>'0'}
              <p class="times">{$one.pay_time|date="Y.m.d"}</p>
              <p class="times">{$one.pay_time|date="H:i:s"}</p>
            {/if}
          </div>
          <div class="items {if $one.send_time>'0'}active{/if}">
            <div class="itemsa">1</div>
            <div class="xianl"></div>
            <div class="xianr"></div>
            <p class="title">商家发货</p>
            {if $one.send_time>'0'}
            <p class="times">{$one.send_time|date="Y.m.d"}</p>
            <p class="times">{$one.send_time|date="H:i:s"}</p>
            {/if}
          </div>
          <div class="items {if $one.finish_time>'0'}active{/if}">
            <div class="itemsa">1</div>
            <div class="xianl"></div>
            <p class="title">订单完成</p>
            {if $one.finish_time>'0'}
            <p class="times">{$one.finish_time|date="Y.m.d"}</p>
            <p class="times">{$one.finish_time|date="H:i:s"}</p>
            {/if}
          </div>
          <div class="clear"></div>
        </div>
        {/if}
        <div class="orders">
          <div class="lefts">订单编号：</div>
          <div class="rights">{$one.ordersn} {if orderZidan($one.id)>0}<a href="{:url('admin/orders/lists',['zid'=>$one.id])}" style="color:#23a5f0;padding-left:20px;">查看子订单</a> {/if}</div>
          <div class="clear"></div>
          <div class="lefts">付款方式：</div>
          <div class="rights">
            {if $one.pay_time>'0'}
              {if $one.pay_type=='alipay'} <img src="{:statics('img')}alipay.png" alt="" style="height:20px">支付宝支付{/if}
              {if $one.pay_type=='wxpay'}  <img src="{:statics('img')}wxpay.png" alt="" style="height:20px">微信支付{/if}
              {if $one.pay_type=='yuepay'} <img src="{:statics('img')}yuepay.png" alt="" style="height:20px">余额支付{/if}
              {if $one.pay_type=='htpay'}后台支付{/if}
            {else /}
              未付款
            {/if}
          </div>
          <div class="clear"></div>
          <div class="lefts">购买人：</div>
          <div class="rights"><a href="" style="color: #23a5f0">{$one.user_id|getMember}</a></div>
          <div class="clear"></div>
          <div class="lefts">配送方式：</div>
          <div class="rights">
            {if $one.express_company!=''}
              {$one.express_company}
            {else /}
              快递
            {/if}
          </div>
          <div class="clear"></div>
          <div class="lefts">收货人：</div>
          <div class="rights">
            <span id="text">{$one.consignee_address}，{$one.consignee_name}，{$one.consignee_mobile}</span>
            <a href="javascript:void(0);" style="color: #23a5f0" onclick="myCopy('text')">复制</a>
          </div>
          <div class="clear"></div>
          {if in_array($one.status,[0,1])}
          <div class="buooms">
            <a href="javascript:void(0);" onclick="x_admin_show('编辑收货信息','{:url('admin/orders/address_publish',['id'=>$one.id])}',900,400)">修改订单收货信息</a>
          </div>
          {/if}
          <div class="clear" style="height:40px"></div>
        </div>
        <div class="zhuangtai">
          <div class="lefts">订单状态：</div>
          <div class="rights">
            {if $one.status=='-5'}<span style="color:#23a5f0;font-size:18px;">维权完成</span>{/if}
            {if $one.status=='-4'}<span style="color:#23a5f0;font-size:18px;">退货中</span>{/if}
            {if $one.status=='-3'}<span style="color:#23a5f0;font-size:18px;">退款中</span>{/if}
            {if $one.status=='-2'}<span style="color:#23a5f0;font-size:18px;">维权中</span>{/if}
            {if $one.status=='-1'}<span style="color:red;font-size:18px;">已取消</span>{/if}
            {if $one.status=="0"}<span style="color:#23a5f0;font-size:18px;">待付款</span>{/if}
            {if $one.status=="1"}<span style="color:#23a5f0;font-size:18px;">待发货</span>{/if}
            {if $one.status=="2"}<span style="color:#23a5f0;font-size:18px;">待收货</span>{/if}
            {if $one.status=="3"}<span style="color:#23a5f0;font-size:18px;">待评价</span>{/if}
            {if $one.status=="4"}<span style="color:green;font-size:18px;">已完成</span>{/if}
          </div>
          {if $one.send_time>'0'}
            <div class="clear" style="height: 30px;"></div>
            <div class="leftsa">快递公司：</div>
            <div class="rightsa">{$one.express_company}</div>
            <div class="clear"></div>
            <div class="leftsa">快递单号：</div>
            <div class="rightsa">
              {$one.express_sn}
              <a href="javascript:void(0);" onclick="x_admin_show('物流信息','{:url('admin/orders/wuliu',['id'=>$one.id])}')" style="color:#23a5f0;padding-left: 10px;">查看物流</a>
            </div>
            <div class="clear"></div>
            <div class="leftsa">发货时间：</div>
            <div class="rightsa">{$one.send_time|date="Y.m.d H:i:s"}</div>
          {/if}
          <div class="clear"></div>
          <div class="buttoms">
            {if $one.status=="0"}
              <a href="javascript:void(0);" onclick="x_admin_show('确认付款','{:url('admin/orders/fukuan_publish',['id'=>$one.id])}',700,390)">确认付款</a><br/>
            {/if}
            {if $one.status=="1"}
              <a href="javascript:void(0);" onclick="x_admin_show('确认发货','{:url('admin/orders/fahuo_publish',['id'=>$one.id])}',700,390)">确认发货</a><br/>
            {/if}
            {if $one.status=="2"}
              <a href="javascript:void(0);" onclick="shouhuo('{$one.id}')">确认收货</a><br/>
              <span onclick="x_admin_show('修改物流','{:url('admin/orders/fahuo_publish',['id'=>$one.id])}',700,390)">修改物流</span>
              <span onclick="quxiao('{$one.id}')">取消发货</span>
            {/if}
            {if $one.status=="3"}<a href="javascript:void(0);" onclick="wancheng('{$one.id}')">确认完成</a><br/>{/if}
            <br/><span onclick="x_admin_show('添加备注','{:url('admin/orders/beizhu',['id'=>$one.id])}',600,400)">添加备注</span>
          </div>
          {if in_array($one.status,[3,4])}
            <div class="tishi">
              友情提示： 交易成功，如买家有售后申请，请与买家进行协商，妥善处理
            </div>
          {/if}
        </div>
        <div class="clear"></div>
        <p style="font-size:18px;padding:20px 0;">商品信息</p>
        <table class="goods">
          <tr>
            <th style="text-align: left;">商品标题</th>
            <th style="text-align: left;" width="180">规格/编号/条码</th>
            <th width="100">单价</th>
            <th width="50">数量</th>
            <th width="100">商品金额</th>
            <th width="60">邮费</th>
            <th width="80">优惠金额</th>
            <th width="100">实付金额</th>
            <th width="140">奖励</th>
          </tr>
          {foreach name="goods" item="v"}
            <tr>
              <td>
                <img src="{$v.image}" alt="" style="height:80px;">
                <div>{$v.title}</div>
              </td>
              <td style="text-align: left;">
                <p>规格：{$v.desc_title}</p>
                <p>编号：{$v.goodssn?$v.goodssn:'无'}</p>
                <p>条码：{$v.productsn?$v.productsn:'无'}</p>
              </td>
              <td>
                ￥{$v.marketprice} 
                {if $v.marketprice<$v.goodsprice}
                  <br/><span style="text-decoration: line-through;color:#ccc">￥{$v.goodsprice}</span>
                {/if}
              </td>
              <td> x {$v.total}</td>
              <td>￥{:sprintf('%.2f',round($v.marketprice*$v.total,2))}</td>
              <td>
                ￥{:sprintf('%.2f',round($v.realpostageprice*$v.total,2))}
                {if sprintf('%.2f',round($v.realpostageprice*$v.total,2))<$v.postageprice}
                <br/><span style="text-decoration: line-through;color:#ccc">￥{$v.postageprice}</span>
                {/if}
              </td>
              <td style="color: red">-￥{:sprintf('%.2f',round($v.discount*$v.total,2))}</td>
              <td>￥{:sprintf('%.2f',round(($v.realprice*$v.total+$v.realpostageprice*$v.total),2))}</td>
              <td>
                <p>一级：￥{:sprintf('%.2f',round($v.distribution*$v.total,2))}</p>
                <p>二级：￥{:sprintf('%.2f',round($v.distribution_2*$v.total,2))}</p>
                <p>三级：￥{:sprintf('%.2f',round($v.distribution_3*$v.total,2))}</p>
              </td>
            </tr>
          {/foreach}
          <tr class="heji">
            <td colspan="3" style="text-align: right;">合计：</td>
            <td>{$one.shuliang}</td>
            <td>￥{$one.goodsprice}</td>
            <td>￥{$one.postageprice}</td>
            <td style="color: red">-￥{$one.discount?$one.discount:'0.00'}</td>
            <td>￥{$one.price}</td>
            <td style="color: red">￥{:sprintf('%.2f',round($one.jiangli,2))}</td>
          </tr>
        </table>
      </div>
    </div>
  </div>
</body>
<script type="text/javascript">
  function myCopy($id){
    selectText($id);
    document.execCommand('copy');
    layer.msg('复制成功',{icon:1})
  }
  var hh = $('.orders').css('height');
  $('.zhuangtai').css('height',hh);
  function selectText(element) {
    var text = document.getElementById(element);
    //做下兼容
    if (document.body.createTextRange) {  //如果支持
      var range = document.body.createTextRange(); //获取range
      range.moveToElementText(text); //光标移上去
      range.select();  //选择
    } else if (window.getSelection) {
      var selection = window.getSelection(); //获取selection
      var range = document.createRange(); //创建range
          range.selectNodeContents(text);  //选择节点内容
          selection.removeAllRanges(); //移除所有range
          selection.addRange(range);  //添加range
          /*if(selection.setBaseAndExtent){
          selection.setBaseAndExtent(text, 0, text, 1);
          }*/
    } else {
      layer.msg('复制失败，请使用右键复制或者Ctrl+C复制')
    }
  }
  function quxiao(id){
    layer.confirm('确认要取消发货吗？',function(index){
        //发异步删除数据
        $.ajax({
          url:"{:url('admin/orders/fahuo_cancel')}",
          data:{id:id},
          dataType:'json',
          type:'post',
          success:function(res){
            if(res.code=='0'){
              layer.msg(res.msg,{icon:1,time:2000});
              setTimeout(function(){
                location.replace(location.href);
              },2000);
            }else{
              layer.msg(res.msg,{icon:2,time:1000});
            }
          },
          error:function(res){
            layer.msg('网络连接错误',{icon:2,time:1000});
          }
        })
    });
  }
  function shouhuo(id){
    layer.confirm('确认可以收货了吗？',function(index){
        //发异步删除数据
        $.ajax({
          url:"{:url('admin/orders/shouhuo')}",
          data:{id:id},
          dataType:'json',
          type:'post',
          success:function(res){
            if(res.code=='0'){
              layer.msg(res.msg,{icon:1,time:2000});
              setTimeout(function(){
                location.replace(location.href);
              },2000);
            }else{
              layer.msg(res.msg,{icon:2,time:1000});
            }
          },
          error:function(res){
            layer.msg('网络连接错误',{icon:2,time:1000});
          }
        })
    });
  }
  function wancheng(id){
    layer.confirm('确认可以完成该订单了吗？',function(index){
        //发异步删除数据
        $.ajax({
          url:"{:url('admin/orders/wancheng')}",
          data:{id:id},
          dataType:'json',
          type:'post',
          success:function(res){
            if(res.code=='0'){
              layer.msg(res.msg,{icon:1,time:2000});
              setTimeout(function(){
                location.replace(location.href);
              },2000);
            }else{
              layer.msg(res.msg,{icon:2,time:1000});
            }
          },
          error:function(res){
            layer.msg('网络连接错误',{icon:2,time:1000});
          }
        })
    });
  }
</script>
</html>